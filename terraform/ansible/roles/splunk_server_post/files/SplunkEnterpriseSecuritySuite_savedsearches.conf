[Threat - proc_access_win_hktl_generic_access.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_access_win_hktl_generic_access.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_access_win_hktl_generic_access.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/process_access/proc_access_win_hktl_generic_access.yml#L4\
\
Detects process access requests from hacktool processes based on their default image name\
\
https://jsecurity101.medium.com/bypassing-access-mask-auditing-strategies-480fb641c158\
https://www.splunk.com/en_us/blog/security/you-bet-your-lsass-hunting-lsass-access.html
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win SourceImage IN ("*\\Akagi.exe", "*\\Akagi64.exe", "*\\atexec_windows.exe", "*\\Certify.exe", "*\\Certipy.exe", "*\\CoercedPotato.exe", "*\\crackmapexec.exe", "*\\CreateMiniDump.exe", "*\\dcomexec_windows.exe", "*\\dpapi_windows.exe", "*\\findDelegation_windows.exe", "*\\GetADUsers_windows.exe", "*\\GetNPUsers_windows.exe", "*\\getPac_windows.exe", "*\\getST_windows.exe", "*\\getTGT_windows.exe", "*\\GetUserSPNs_windows.exe", "*\\gmer.exe", "*\\hashcat.exe", "*\\htran.exe", "*\\ifmap_windows.exe", "*\\impersonate.exe", "*\\Inveigh.exe", "*\\LocalPotato.exe", "*\\mimikatz_windows.exe", "*\\mimikatz.exe", "*\\netview_windows.exe", "*\\nmapAnswerMachine_windows.exe", "*\\opdump_windows.exe", "*\\PasswordDump.exe", "*\\Potato.exe", "*\\PowerTool.exe", "*\\PowerTool64.exe", "*\\psexec_windows.exe", "*\\PurpleSharp.exe", "*\\pypykatz.exe", "*\\QuarksPwDump.exe", "*\\rdp_check_windows.exe", "*\\Rubeus.exe", "*\\SafetyKatz.exe", "*\\sambaPipe_windows.exe", "*\\SelectMyParent.exe", "*\\SharpChisel.exe", "*\\SharPersist.exe", "*\\SharpEvtMute.exe", "*\\SharpImpersonation.exe", "*\\SharpLDAPmonitor.exe", "*\\SharpLdapWhoami.exe", "*\\SharpUp.exe", "*\\SharpView.exe", "*\\smbclient_windows.exe", "*\\smbserver_windows.exe", "*\\sniff_windows.exe", "*\\sniffer_windows.exe", "*\\split_windows.exe", "*\\SpoolSample.exe", "*\\Stracciatella.exe", "*\\SysmonEOP.exe", "*\\temp\\rot.exe", "*\\ticketer_windows.exe", "*\\TruffleSnout.exe", "*\\winPEASany_ofs.exe", "*\\winPEASany.exe", "*\\winPEASx64_ofs.exe", "*\\winPEASx64.exe", "*\\winPEASx86_ofs.exe", "*\\winPEASx86.exe", "*\\xordump.exe") OR SourceImage IN ("*\\goldenPac*", "*\\just_dce_*", "*\\karmaSMB*", "*\\kintercept*", "*\\LocalPotato*", "*\\ntlmrelayx*", "*\\rpcdump*", "*\\samrdump*", "*\\secretsdump*", "*\\smbexec*", "*\\smbrelayx*", "*\\wmiexec*", "*\\wmipersist*", "*HotPotato*", "*Juicy Potato*", "*JuicyPotato*", "*PetitPotam*", "*RottenPotato*")

[Threat - file_event_win_bloodhound_collection.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1087.001","T1087.002","T1482","T1069.001","T1069.002","T1059.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = file_event_win_bloodhound_collection.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = file_event_win_bloodhound_collection.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/file/file_event/file_event_win_bloodhound_collection.yml#L4\
\
Detects default file names outputted by the BloodHound collection tool SharpHound\
\
https://academy.hackthebox.com/course/preview/active-directory-bloodhound/bloodhound--data-collection
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win TargetFilename IN ("*BloodHound.zip", "*_computers.json", "*_containers.json", "*_domains.json", "*_gpos.json", "*_groups.json", "*_ous.json", "*_users.json") NOT (Image="*\\svchost.exe" TargetFilename="C:\\Program Files\\WindowsApps\\Microsoft.*" TargetFilename="*\\pocket_containers.json")

[Threat - file_event_win_hktl_mimikatz_files.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1558"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = file_event_win_hktl_mimikatz_files.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = file_event_win_hktl_mimikatz_files.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/file/file_event/file_event_win_hktl_mimikatz_files.yml#L4\
\
Detects the creation of files created by mimikatz such as ".kirbi", "mimilsa.log", etc.\
\
https://cobalt.io/blog/kerberoast-attack-techniques\
https://pentestlab.blog/2019/10/21/persistence-security-support-provider/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win TargetFilename IN ("*.kirbi", "*mimilsa.log")

[Threat - proc_access_win_lsass_werfault.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_access_win_lsass_werfault.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_access_win_lsass_werfault.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/process_access/proc_access_win_lsass_werfault.yml#L4\
\
Detects process LSASS memory dump using Mimikatz, NanoDump, Invoke-Mimikatz, Procdump or Taskmgr based on the CallTrace pointing to ntdll.dll, dbghelp.dll\
\
https://github.com/helpsystems/nanodump/commit/578116faea3d278d53d70ea932e2bbfe42569507
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win SourceImage="*\\WerFault.exe" TargetImage="*\\lsass.exe" GrantedAccess="0x1FFFFF"

[Threat - win_security_user_added_to_local_administrators.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1078","T1098"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_security_user_added_to_local_administrators.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_security_user_added_to_local_administrators.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/security/win_security_user_added_to_local_administrators.yml#L4\
\
Detects the addition of a new member to the local administrator group, which could be legitimate activity or a sign of privilege escalation activity\
\
https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4732\
https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Security" EventCode=4732 TargetUserName="Administr*" OR TargetSid="S-1-5-32-544" NOT SubjectUserName="*$"

[Threat - win_security_susp_net_recon_activity.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1087.002","T1069.002"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_security_susp_net_recon_activity.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_security_susp_net_recon_activity.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/security/win_security_susp_net_recon_activity.yml#L4\
\
Detects activity as "net user administrator /domain" and "net group domain admins /domain"\
\
https://findingbad.blogspot.de/2017/01/hunting-what-does-it-look-like.html
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Security" EventCode=4661 AccessMask="0x2d" ObjectType IN ("SAM_USER", "SAM_GROUP") ObjectName="S-1-5-21-*" ObjectName IN ("*-500", "*-512")

[Threat - win_security_susp_lsass_dump.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_security_susp_lsass_dump.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_security_susp_lsass_dump.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/security/win_security_susp_lsass_dump_generic.yml#L4\
\
Detects process handle on LSASS process with certain access mask\
\
https://web.archive.org/web/20230208123920/https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html\
https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Security" EventCode=4656 ProcessName="*\\lsass.exe" AccessMask="0x705" ObjectType="SAM_DOMAIN"

[Threat - proc_creation_win_bitsadmin_download_file_sharing_domains.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1179","T1036.003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_bitsadmin_download_file_sharing_domains.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_bitsadmin_download_file_sharing_domains.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/process_creation/proc_creation_win_bitsadmin_download_file_sharing_domains.yml#L4\
\
Detects usage of bitsadmin downloading a file from a suspicious domain\
\
\
https://blog.netspi.com/15-ways-to-download-a-file/#bitsadmin\
https://isc.sans.edu/diary/22264\
https://lolbas-project.github.io/lolbas/Binaries/Bitsadmin/\
https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/ransomware-hive-conti-avoslocker\
https://www.cisa.gov/uscert/ncas/alerts/aa22-321a\
https://www.microsoft.com/en-us/security/blog/2024/01/17/new-ttps-observed-in-mint-sandstorm-campaign-targeting-high-profile-individuals-at-universities-and-research-orgs/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Image="*\\bitsadmin.exe" OR OriginalFileName="bitsadmin.exe" CommandLine IN ("* /transfer *", "* /create *", "* /addfile *") CommandLine IN ("*.githubusercontent.com*", "*anonfiles.com*", "*cdn.discordapp.com*", "*ddns.net*", "*dl.dropboxusercontent.com*", "*ghostbin.co*", "*glitch.me*", "*gofile.io*", "*hastebin.com*", "*mediafire.com*", "*mega.nz*", "*onrender.com*", "*pages.dev*", "*paste.ee*", "*pastebin.com*", "*pastebin.pl*", "*pastetext.net*", "*privatlab.com*", "*privatlab.net*", "*send.exploit.in*", "*sendspace.com*", "*storage.googleapis.com*", "*storjshare.io*", "*supabase.co*", "*temp.sh*", "*transfer.sh*", "*trycloudflare.com*", "*ufile.io*", "*w3spaces.com*", "*workers.dev*")

[Threat - win_security_ad_user_enumeration.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1087.002"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_security_ad_user_enumeration.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_security_ad_user_enumeration.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/security/win_security_ad_user_enumeration.yml#L4\
\
Detects read access to a domain user from a non-machine account\
\
https://www.specterops.io/assets/resources/an_ace_up_the_sleeve.pdf\
http://www.stuffithoughtiknew.com/2019/02/detecting-bloodhound.html\
https://learn.microsoft.com/en-us/windows/win32/adschema/attributes-all # For further investigation of the accessed properties\
https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4662
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Security" EventCode=4662 ObjectType="*bf967aba-0de6-11d0-a285-00aa003049e2*" AccessMask IN ("*1*", "*3*", "*4*", "*7*", "*9*", "*B*", "*D*", "*F*") NOT (SubjectUserName IN ("*$", "MSOL_*"))

[Threat - win_security_account_discovery.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1087.002"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_security_account_discovery.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_security_account_discovery.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/security/win_security_account_discovery.yml#L4\
\
Detect priv users or groups recon based on 4661 eventid and known privileged users or groups SIDs\
\
https://web.archive.org/web/20230329163438/https://blog.menasec.net/2019/02/threat-hunting-5-detecting-enumeration.html
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Security" EventCode=4661 ObjectType IN ("SAM_USER", "SAM_GROUP") ObjectName IN ("*-512", "*-502", "*-500", "*-505", "*-519", "*-520", "*-544", "*-551", "*-555") OR ObjectName="*admin*" NOT SubjectUserName="*$"

[Threat - win_ldap_recon.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1069.002","T1087.002","T1482"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_ldap_recon.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_ldap_recon.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/ldap/win_ldap_recon.yml#L4\
\
Detects potential Active Directory enumeration via LDAP\
\
https://techcommunity.microsoft.com/t5/microsoft-defender-for-endpoint/hunting-for-reconnaissance-activities-using-ldap-search-filters/ba-p/824726\
https://github.com/PowerShellMafia/PowerSploit/blob/d943001a7defb5e0d1657085a77a0e78609be58f/Recon/PowerView.ps1\
https://github.com/BloodHoundAD/SharpHound3/blob/7d96b991b1887ff50349ce59c80980bc0d95c86a/SharpHound3/LdapBuilder.cs\
https://medium.com/falconforce/falconfriday-detecting-active-directory-data-collection-0xff21-c22d1a57494c\
https://github.com/fox-it/BloodHound.py/blob/d65eb614831cd30f26028ccb072f5e77ca287e0b/bloodhound/ad/domain.py#L427\
https://ipurple.team/2024/07/15/sharphound-detection/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win (EventCode=30 SearchFilter IN ("*(groupType:1.2.840.113556.1.4.803:=2147483648)*", "*(groupType:1.2.840.113556.1.4.803:=2147483656)*", "*(groupType:1.2.840.113556.1.4.803:=2147483652)*", "*(groupType:1.2.840.113556.1.4.803:=2147483650)*", "*(sAMAccountType=805306369)*", "*(sAMAccountType=805306368)*", "*(sAMAccountType=536870913)*", "*(sAMAccountType=536870912)*", "*(sAMAccountType=268435457)*", "*(sAMAccountType=268435456)*", "*(objectCategory=groupPolicyContainer)*", "*(objectCategory=organizationalUnit)*", "*(objectCategory=Computer)*", "*(objectCategory=nTDSDSA)*", "*(objectCategory=server)*", "*(objectCategory=domain)*", "*(objectCategory=person)*", "*(objectCategory=group)*", "*(objectCategory=user)*", "*(objectClass=trustedDomain)*", "*(objectClass=computer)*", "*(objectClass=server)*", "*(objectClass=group)*", "*(objectClass=user)*", "*(primaryGroupID=521)*", "*(primaryGroupID=516)*", "*(primaryGroupID=515)*", "*(primaryGroupID=512)*", "*Domain Admins*", "*objectGUID=\**", "*(schemaIDGUID=\*)*", "*admincount=1*") NOT (EventCode=30 SearchFilter IN ("*(domainSid=*)*", "*(objectSid=*)*"))) OR (EventCode=30 SearchFilter IN ("*(userAccountControl:1.2.840.113556.1.4.803:=4194304)*", "*(userAccountControl:1.2.840.113556.1.4.803:=2097152)*", "*!(userAccountControl:1.2.840.113556.1.4.803:=1048574)*", "*(userAccountControl:1.2.840.113556.1.4.803:=524288)*", "*(userAccountControl:1.2.840.113556.1.4.803:=65536)*", "*(userAccountControl:1.2.840.113556.1.4.803:=8192)*", "*(userAccountControl:1.2.840.113556.1.4.803:=544)*", "*!(UserAccountControl:1.2.840.113556.1.4.803:=2)*", "*msDS-AllowedToActOnBehalfOfOtherIdentity*", "*msDS-AllowedToDelegateTo*", "*msDS-GroupManagedServiceAccount*", "*(accountExpires=9223372036854775807)*", "*(accountExpires=0)*", "*(adminCount=1)*", "*ms-MCS-AdmPwd*")) OR (EventCode=30 SearchFilter="(objectclass=\*)" DistinguishedName IN ("*CN=Domain Admins*", "*CN=Enterprise Admins*", "*CN=Group Policy Creator Owners*"))

[Threat - proc_creation_win_hktl_bloodhound_sharphound.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1087.001","T1087.002","T1482","T1069.001","T1069.002","T1059.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_hktl_bloodhound_sharphound.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_hktl_bloodhound_sharphound.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/process_creation/proc_creation_win_hktl_bloodhound_sharphound.yml#L4\
\
Detects command line parameters used by Bloodhound and Sharphound hack tools\
\
https://github.com/BloodHoundAD/BloodHound\
https://github.com/BloodHoundAD/SharpHound
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Product="*SharpHound*" OR Description="*SharpHound*" OR Company IN ("*SpecterOps*", "*evil corp*") OR Image IN ("*\\Bloodhound.exe*", "*\\SharpHound.exe*") OR CommandLine IN ("* -CollectionMethod All *", "* --CollectionMethods Session *", "* --Loop --Loopduration *", "* --PortScanTimeout *", "*.exe -c All -d *", "*Invoke-Bloodhound*", "*Get-BloodHoundData*") OR (CommandLine="* -JsonFolder *" CommandLine="* -ZipFileName *") OR (CommandLine="* DCOnly *" CommandLine="* --NoSaveCache *")

[Threat - proc_creation_win_net_groups_and_accounts_recon.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1087.001","T1087.002"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_net_groups_and_accounts_recon.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_net_groups_and_accounts_recon.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/process_creation/proc_creation_win_net_groups_and_accounts_recon.yml#L4\
\
Detects suspicious reconnaissance command line activity on Windows systems using Net.EXE Check if the user that executed the commands is suspicious (e.g. service accounts, LOCAL_SYSTEM)\
\
https://redcanary.com/blog/how-one-hospital-thwarted-a-ryuk-ransomware-outbreak/\
https://thedfirreport.com/2020/10/18/ryuk-in-5-hours/\
https://research.nccgroup.com/2022/08/19/back-in-black-unlocking-a-lockbit-3-0-ransomware-attack/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Image IN ("*\\net.exe", "*\\net1.exe") OR OriginalFileName IN ("net.exe", "net1.exe") (CommandLine IN ("* group *", "* localgroup *") CommandLine IN ("*domain admins*", "* administrator*", "* administrateur*", "*enterprise admins*", "*Exchange Trusted Subsystem*", "*Remote Desktop Users*", "*Utilisateurs du Bureau Ã  distance*", "*Usuarios de escritorio remoto*", "* /do*") NOT CommandLine="* /add*") OR (CommandLine="* accounts *" CommandLine="* /do*")

[Threat - win_defender_tamper_protection_trigger.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1562.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_defender_tamper_protection_trigger.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_defender_tamper_protection_trigger.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/windefend/win_defender_tamper_protection_trigger.yml#L4\
\
Detects blocked attempts to change any of Defender's settings such as "Real Time Monitoring" and "Behavior Monitoring"\
\
https://bhabeshraj.com/post/tampering-with-microsoft-defenders-tamper-protection\
https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Microsoft-Windows-Windows Defender/Operational" EventCode=5013 Value IN ("*\\Windows Defender\\DisableAntiSpyware", "*\\Windows Defender\\DisableAntiVirus", "*\\Windows Defender\\Scan\\DisableArchiveScanning", "*\\Windows Defender\\Scan\\DisableScanningNetworkFiles", "*\\Real-Time Protection\\DisableRealtimeMonitoring", "*\\Real-Time Protection\\DisableBehaviorMonitoring", "*\\Real-Time Protection\\DisableIOAVProtection", "*\\Real-Time Protection\\DisableScriptScanning")

[Threat - sysmon_mimikatz_detection_lsass.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = sysmon_mimikatz_detection_lsass.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = sysmon_mimikatz_detection_lsass.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/deprecated/windows/sysmon_mimikatz_detection_lsass.yml#L4\
\
Detects process access to LSASS which is typical for Mimikatz (0x1000 PROCESS_QUERY_ LIMITED_INFORMATION, 0x0400 PROCESS_QUERY_ INFORMATION "only old\
    versions", 0x0010 PROCESS_VM_READ)\
\
https://onedrive.live.com/view.aspx?resid=D026B4699190F1E6!2843&ithint=file%2cpptx&app=PowerPoint&authkey=!AMvCRTKB_V1J5ow\
https://web.archive.org/web/20230208123920/https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win TargetImage="*\\lsass.exe" GrantedAccess IN ("0x1410", "0x1010", "0x410") NOT (SourceImage IN ("C:\\Program Files\\WindowsApps\\*", "C:\\Windows\\System32\\*") SourceImage="*\\GamingServices.exe") | table ComputerName,User,SourceImage

[Threat - win_defender_suspicious_features_tampering.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1562.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_defender_suspicious_features_tampering.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_defender_suspicious_features_tampering.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/windefend/win_defender_suspicious_features_tampering.yml#L4\
\
Detects suspicious changes to the Windows Defender configuration\
\
https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide\
https://bidouillesecurity.com/disable-windows-defender-in-powershell/#DisableAntiSpyware
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Microsoft-Windows-Windows Defender/Operational" EventCode=5007 New_Value IN ("*\\Windows Defender\\DisableAntiSpyware *", "*\\Windows Defender\\Scan\\DisableRemovableDriveScanning *", "*\\Windows Defender\\Scan\\DisableScanningMappedNetworkDrivesForFullScan *", "*\\Windows Defender\\SpyNet\\DisableBlockAtFirstSeen *", "*\\Real-Time Protection\\SpyNetReporting *")

[Threat - win_alert_mimikatz_keywords.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1003.002","T1003.001","T1003.004","T1003.006"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_alert_mimikatz_keywords.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_alert_mimikatz_keywords.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/win_alert_mimikatz_keywords.yml#L4\
\
This method detects mimikatz keywords in different Eventlogs (some of them only appear in older Mimikatz version that are however still used by different threat groups)\
\
https://tools.thehacker.recipes/mimikatz/modules
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win "dpapi::masterkey" OR "eo.oe.kiwi" OR "event::clear" OR "event::drop" OR "gentilkiwi.com" OR "kerberos::golden" OR "kerberos::ptc" OR "kerberos::ptt" OR "kerberos::tgt" OR "Kiwi Legit Printer" OR "lsadump::" OR "mimidrv.sys" OR "\\mimilib.dll" OR "misc::printnightmare" OR "misc::shadowcopies" OR "misc::skeleton" OR "privilege::backup" OR "privilege::debug" OR "privilege::driver" OR "sekurlsa::" NOT EventCode=15

[Threat - win_defender_real_time_protection_disabled.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1562.001"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_defender_real_time_protection_disabled.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_defender_real_time_protection_disabled.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/builtin/windefend/win_defender_real_time_protection_disabled.yml#L4\
\
Detects disabling of Windows Defender Real-time Protection. As this event doesn't contain a lot of information on who initiated this action you might want to reduce it to a "medium" level if this occurs too many times in your environment\
\
\
https://learn.microsoft.com/en-us/defender-endpoint/troubleshoot-microsoft-defender-antivirus?view=o365-worldwide#event-id-5001\
https://github.com/redcanaryco/atomic-red-team/blob/f339e7da7d05f6057fdfcdd3742bfcf365fee2a9/atomics/T1562.001/T1562.001.md\
https://craigclouditpro.wordpress.com/2020/03/04/hunting-malicious-windows-defender-activity/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = source="XmlWinEventLog:Microsoft-Windows-Windows Defender/Operational" EventCode=5001

[Threat - proc_creation_win_bitsadmin_download.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1197","T1036.003"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_bitsadmin_download.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_bitsadmin_download.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/4f4ef7a8cc077b2b54c71c598db50fe8b1f14d55/rules/windows/process_creation/proc_creation_win_bitsadmin_download.yml#L4\
\
Detects usage of bitsadmin downloading a file\
\
https://blog.netspi.com/15-ways-to-download-a-file/#bitsadmin\
https://isc.sans.edu/diary/22264\
https://lolbas-project.github.io/lolbas/Binaries/Bitsadmin/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Image="*\\bitsadmin.exe" OR OriginalFileName="bitsadmin.exe" CommandLine="* /transfer *" OR (CommandLine IN ("* /create *", "* /addfile *") CommandLine="*http*") | table CommandLine,ParentCommandLine

[Threat - proc_creation_win_pua_rclone_execution.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1567.002"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_pua_rclone_execution.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_pua_rclone_execution.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/d804e9cba10fa2e3bdabeca0cc330158c58de016/rules/windows/process_creation/proc_creation_win_pua_rclone_execution.yml#L4\
\
Detects execution of RClone utility for exfiltration as used by various ransomwares strains like REvil, Conti, FiveHands, etc\
\
https://research.nccgroup.com/2021/05/27/detecting-rclone-an-effective-tool-for-exfiltration/\
https://thedfirreport.com/2021/03/29/sodinokibi-aka-revil-ransomware\
https://us-cert.cisa.gov/ncas/analysis-reports/ar21-126a\
https://labs.sentinelone.com/egregor-raas-continues-the-chaos-with-cobalt-strike-and-rclone\
https://www.splunk.com/en_us/blog/security/darkside-ransomware-splunk-threat-update-and-detections.html
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win (Product="*Rclone*" OR Description="*Rclone*" OR Company IN ("*rclone*") OR Image IN ("*\\RClone.exe*")) AND CommandLine IN ("*copy*","*ftp*","*pass*","*user*","*sync*","*config*","*lsd*","*remote*","*ls*","*mega*","*pcloud*","*ignore-existing*","*auto-confirm*","*transfers*","*multi-thread-streams*","*no-check-certificate*")

[Threat - proc_creation_win_susp_shadow_copies_deletion.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1070","T1490"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_susp_shadow_copies_deletion.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_susp_shadow_copies_deletion.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/6fd57da13139643c6fe3e4a23276ca6ae9a6eec7/rules/windows/process_creation/proc_creation_win_susp_shadow_copies_deletion.yml#L4\
\
Shadow Copies deletion using operating systems utilities\
\
https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment\
https://blog.talosintelligence.com/2017/05/wannacry.html\
https://securingtomorrow.mcafee.com/other-blogs/mcafee-labs/new-teslacrypt-ransomware-arrives-via-spam/\
https://www.bleepingcomputer.com/news/security/why-everyone-should-disable-vssadmin-exe-now/\
https://www.hybrid-analysis.com/sample/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa?environmentId=100\
https://github.com/Neo23x0/Raccine#the-process\
https://github.com/Neo23x0/Raccine/blob/20a569fa21625086433dcce8bb2765d0ea08dcb6/yara/gen_ransomware_command_lines.yar\
https://redcanary.com/blog/intelligence-insights-october-2021/\
https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/blackbyte-exbyte-ransomware\
author: Florian Roth (Nextron Systems), Michael Haag, Teymur Kheirkhabarov, Daniil Yugoslavskiy, oscd.community, Andreas Hunkeler (@Karneades)
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win (Image IN ("*\\powershell.exe", "*\\pwsh.exe", "*\\wmic.exe", "*\\vssadmin.exe", "*\\diskshadow.exe") OR OriginalFileName IN ("PowerShell.EXE", "pwsh.dll", "wmic.exe", "VSSADMIN.EXE", "diskshadow.exe") CommandLine="*shadow*" CommandLine="*delete*") OR (Image="*\\wbadmin.exe" OR OriginalFileName="WBADMIN.EXE" CommandLine="*delete*" CommandLine="*catalog*" CommandLine="*quiet*") OR (Image="*\\vssadmin.exe" OR OriginalFileName="VSSADMIN.EXE" CommandLine="*resize*" CommandLine="*shadowstorage*" CommandLine IN ("*unbounded*", "*/MaxSize=*")) | table CommandLine,ParentCommandLine

[Threat - proc_creation_win_certutil_download.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1027"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_certutil_download.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_certutil_download.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/6fd57da13139643c6fe3e4a23276ca6ae9a6eec7/rules/windows/process_creation/proc_creation_win_certutil_download.yml#L2\
\
Detects the execution of certutil with certain flags that allow the utility to download files.\
\
https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certutil\
https://forensicitguy.github.io/agenttesla-vba-certutil-download/\
https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/\
https://twitter.com/egre55/status/1087685529016193025\
https://lolbas-project.github.io/lolbas/Binaries/Certutil/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Image="*\\certutil.exe" OR OriginalFileName="CertUtil.exe" CommandLine IN ("*urlcache *", "*verifyctl *") CommandLine="*http*"

[Threat - proc_creation_win_certutil_download_file_sharing_domains.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1027"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = proc_creation_win_certutil_download_file_sharing_domains.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = proc_creation_win_certutil_download_file_sharing_domains.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/6fd57da13139643c6fe3e4a23276ca6ae9a6eec7/rules/windows/process_creation/proc_creation_win_certutil_download_file_sharing_domains.yml\
\
Detects the execution of certutil with certain flags that allow the utility to download files from file-sharing websites.\
\
https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certutil\
https://forensicitguy.github.io/agenttesla-vba-certutil-download/\
https://news.sophos.com/en-us/2021/04/13/compromised-exchange-server-hosting-cryptojacker-targeting-other-exchange-servers/\
https://twitter.com/egre55/status/1087685529016193025\
https://lolbas-project.github.io/lolbas/Binaries/Certutil/\
https://www.microsoft.com/en-us/security/blog/2024/01/17/new-ttps-observed-in-mint-sandstorm-campaign-targeting-high-profile-individuals-at-universities-and-research-orgs/
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Image="*\\certutil.exe" OR OriginalFileName="CertUtil.exe" CommandLine IN ("*urlcache *", "*verifyctl *") CommandLine IN ("*.githubusercontent.com*", "*anonfiles.com*", "*cdn.discordapp.com*", "*ddns.net*", "*dl.dropboxusercontent.com*", "*ghostbin.co*", "*glitch.me*", "*gofile.io*", "*hastebin.com*", "*mediafire.com*", "*mega.nz*", "*onrender.com*", "*pages.dev*", "*paste.ee*", "*pastebin.com*", "*pastebin.pl*", "*pastetext.net*", "*privatlab.com*", "*privatlab.net*", "*send.exploit.in*", "*sendspace.com*", "*storage.googleapis.com*", "*storjshare.io*", "*supabase.co*", "*temp.sh*", "*transfer.sh*", "*trycloudflare.com*", "*ufile.io*", "*w3spaces.com*", "*workers.dev*")

[Threat - net_connection_win_certutil_initiated_connection.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1105"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = net_connection_win_certutil_initiated_connection.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = net_connection_win_certutil_initiated_connection.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = https://github.com/SigmaHQ/sigma/blob/6fd57da13139643c6fe3e4a23276ca6ae9a6eec7/rules/windows/network_connection/net_connection_win_certutil_initiated_connection.yml#L2\
\
Detects a network connection initiated by the certutil.exe utility. Attackers can abuse the utility in order to download malware or additional payloads.\
\
https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certutil
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win Image="*\\certutil.exe" Initiated="true" DestinationPort IN (80, 135, 443, 445)

[Threat - win_ad_domain_admin_pw_reset.yml - Rule]
action.correlationsearch.annotations = {"mitre_attack":["T1098"]}
action.correlationsearch.enabled = 1
action.correlationsearch.label = win_ad_domain_admin_pw_reset.yml
action.customsearchbuilder.enabled = false
action.makestreams.param.verbose = 0
action.nbtstat.param.verbose = 0
action.notable = 1
action.notable.param.drilldown_dashboards = []
action.notable.param.drilldown_searches = []
action.notable.param.rule_title = win_ad_domain_admin_pw_reset.yml
action.notable.param.security_domain = threat
action.notable.param.severity = high
action.notable.param.verbose = 0
action.nslookup.param.verbose = 0
action.ping.param.verbose = 0
action.risk.forceCsvResults = 1
action.risk.param._risk = [{"risk_object_field":"","risk_object_type":"","risk_score":1}]
action.risk.param._risk_score = 0
action.risk.param.verbose = 0
action.send2uba.param.verbose = 0
action.threat_add.param.verbose = 0
action.webhook.enable_allowlist = 0
alert.suppress = 0
alert.track = 1
counttype = number of events
cron_schedule = */5 * * * *
description = Roughly based on https://github.com/mdecrevoisier/SIGMA-detection-rules/blob/2aca9946d75306e91f490b76c95abcae177dd71a/windows-active_directory/win-ad-bruteforce%20via%20password%20reset.yaml#L19.\
\
Self-written search looking for password resets on AD domain administrator users. Windows Event ID 4724 indicates an attempt to reset a user password. The search is further limited to only include domain administrators avoiding noise.\
\
https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4724
dispatch.earliest_time = -5m@m
dispatch.latest_time = now
dispatch.rt_backfill = 1
enableSched = 1
quantity = 0
relation = greater than
request.ui_dispatch_app = SplunkEnterpriseSecuritySuite
search = index=win EventCode=4724 TargetSid IN ("ATTACKRANGE\\Administrator")
